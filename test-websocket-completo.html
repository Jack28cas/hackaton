<!DOCTYPE html>
<html>
<head>
    <title>Test WebSocket Completo</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 15px; margin: 15px 0; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .connected { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .error { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        button { margin: 8px; padding: 12px 20px; cursor: pointer; font-size: 14px; border-radius: 5px; border: none; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .logs { background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; }
        .log-item { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .log-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .log-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .log-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .log-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; }
        .section h3 { margin-top: 0; color: #495057; }
    </style>
</head>
<body>
    <h1>ğŸ”Œ Test WebSocket Completo</h1>
    
    <div id="status" class="status disconnected">Estado: Desconectado</div>
    
    <div class="section">
        <h3>ğŸ”Œ ConexiÃ³n</h3>
        <button class="btn-primary" onclick="testHealth()">ğŸ¥ Test Health Check</button>
        <button class="btn-success" onclick="testConnection()">ğŸ”Œ Conectar WebSocket</button>
        <button class="btn-danger" onclick="disconnect()">âŒ Desconectar</button>
        <button onclick="clearLogs()">ğŸ§¹ Limpiar Logs</button>
    </div>

    <div class="section">
        <h3>ğŸ‘¤ Test como Vendedor</h3>
        <button class="btn-warning" onclick="connectAsVendor()">ğŸ›’ Conectar como Vendedor</button>
        <button class="btn-info" onclick="testVendorConnect()">ğŸ“ Conectar Vendedor (UbicaciÃ³n)</button>
        <button class="btn-info" onclick="testVendorDisconnect()">ğŸ”Œ Desconectar Vendedor</button>
        <button class="btn-info" onclick="testUpdateLocation()">ğŸ—ºï¸ Actualizar UbicaciÃ³n</button>
    </div>

    <div class="section">
        <h3>ğŸ›’ Test como Cliente</h3>
        <button class="btn-warning" onclick="connectAsClient()">ğŸ‘¤ Conectar como Cliente</button>
        <button class="btn-info" onclick="testGetNearbyVendors()">ğŸ” Buscar Vendedores Cercanos</button>
        <button class="btn-info" onclick="testNewOrder()">ğŸ“¦ Enviar Pedido</button>
    </div>

    <div class="section">
        <h3>ğŸ“Š Logs</h3>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        let socket;
        let currentUserType = 'CLIENTE';
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-item log-${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logsEl.appendChild(div);
            logsEl.scrollTop = logsEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(text, type) {
            statusEl.textContent = `Estado: ${text}`;
            statusEl.className = `status ${type}`;
        }

        async function testHealth() {
            log('ğŸ¥ Probando health check...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/health');
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Health check exitoso!`, 'success');
                    log(`ğŸ“Š Status: ${data.status}`, 'success');
                    log(`â° Uptime: ${data.uptime.toFixed(2)}s`, 'success');
                    log(`ğŸ”Œ WebSocket: ${data.websocket}`, 'success');
                } else {
                    log(`âŒ Health check fallÃ³: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Error en health check: ${error.message}`, 'error');
            }
        }

        function testConnection() {
            log('ğŸ”Œ Iniciando conexiÃ³n WebSocket...', 'info');
            
            if (socket) {
                socket.disconnect();
            }

            try {
                socket = io('http://localhost:3001', {
                    auth: {
                        userType: 'CLIENTE',
                        userId: 'test-client-completo'
                    },
                    timeout: 15000,
                    transports: ['websocket', 'polling'],
                    forceNew: true,
                    reconnection: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000
                });

                setupSocketListeners();
            } catch (error) {
                log(`âŒ Error creando socket: ${error.message}`, 'error');
                updateStatus('Error âŒ', 'error');
            }
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
                updateStatus(`Conectado como ${currentUserType} âœ…`, 'connected');
                log('ğŸ‰ Â¡WebSocket conectado exitosamente!', 'success');
                log(`ğŸ“¡ Socket ID: ${socket.id}`, 'success');
                log(`ğŸ”— Transport: ${socket.io.engine.transport.name}`, 'success');
                log(`ğŸ‘¤ Usuario: ${currentUserType}`, 'success');
            });

            socket.on('disconnect', (reason) => {
                updateStatus('Desconectado âŒ', 'disconnected');
                log(`âŒ WebSocket desconectado: ${reason}`, 'error');
            });

            socket.on('connect_error', (err) => {
                updateStatus('Error de conexiÃ³n âŒ', 'error');
                log(`âŒ Error de conexiÃ³n: ${err.message}`, 'error');
            });

            // Eventos especÃ­ficos
            socket.on('vendor_connected', (data) => {
                log(`ğŸŸ¢ Vendedor conectado: ${data.name} en ${data.latitude}, ${data.longitude}`, 'success');
            });

            socket.on('vendor_disconnected', (data) => {
                log(`ğŸ”´ Vendedor desconectado: ${data.vendorId}`, 'warning');
            });

            socket.on('vendor_location_updated', (data) => {
                log(`ğŸ—ºï¸ UbicaciÃ³n actualizada: ${data.vendorId} â†’ ${data.latitude}, ${data.longitude}`, 'info');
            });

            socket.on('order_received', (data) => {
                log(`ğŸ“¥ Pedido recibido: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('nearby_vendors', (vendors) => {
                log(`ğŸ“ Vendedores cercanos encontrados: ${vendors.length}`, 'success');
                vendors.forEach(vendor => {
                    log(`  - ${vendor.name} (${vendor.distance || 'N/A'}km)`, 'info');
                });
            });

            socket.on('order_accepted', (data) => {
                log(`âœ… Pedido aceptado: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('order_rejected', (data) => {
                log(`âŒ Pedido rechazado: ${JSON.stringify(data)}`, 'error');
            });

            socket.on('order_status_changed', (data) => {
                log(`ğŸ”„ Estado de pedido cambiado: ${data.orderId} â†’ ${data.status}`, 'info');
            });

            socket.on('error', (data) => {
                log(`âŒ Error del servidor: ${data.message}`, 'error');
            });
        }

        function connectAsVendor() {
            if (socket) {
                socket.disconnect();
            }

            currentUserType = 'VENDEDOR';
            log('ğŸ›’ Conectando como VENDEDOR...', 'info');

            socket = io('http://localhost:3001', {
                auth: {
                    userType: 'VENDEDOR',
                    userId: 'test-vendor-completo'
                },
                timeout: 15000,
                transports: ['websocket', 'polling'],
                forceNew: true
            });

            setupSocketListeners();
        }

        function connectAsClient() {
            if (socket) {
                socket.disconnect();
            }

            currentUserType = 'CLIENTE';
            log('ğŸ‘¤ Conectando como CLIENTE...', 'info');

            socket = io('http://localhost:3001', {
                auth: {
                    userType: 'CLIENTE',
                    userId: 'test-client-completo'
                },
                timeout: 15000,
                transports: ['websocket', 'polling'],
                forceNew: true
            });

            setupSocketListeners();
        }

        function testVendorConnect() {
            if (!socket || !socket.connected) {
                log('âŒ Socket no conectado', 'error');
                return;
            }

            const location = {
                latitude: 19.4326 + (Math.random() - 0.5) * 0.01,
                longitude: -99.1332 + (Math.random() - 0.5) * 0.01
            };

            log(`ğŸ“ Conectando vendedor en ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`, 'info');
            socket.emit('vendor_connect', location);
        }

        function testVendorDisconnect() {
            if (!socket || !socket.connected) {
                log('âŒ Socket no conectado', 'error');
                return;
            }

            log('ğŸ”Œ Desconectando vendedor...', 'info');
            socket.emit('vendor_disconnect');
        }

        function testUpdateLocation() {
            if (!socket || !socket.connected) {
                log('âŒ Socket no conectado', 'error');
                return;
            }

            const location = {
                latitude: 19.4326 + (Math.random() - 0.5) * 0.01,
                longitude: -99.1332 + (Math.random() - 0.5) * 0.01
            };

            log(`ğŸ—ºï¸ Actualizando ubicaciÃ³n a ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`, 'info');
            socket.emit('update_location', location);
        }

        function testGetNearbyVendors() {
            if (!socket || !socket.connected) {
                log('âŒ Socket no conectado', 'error');
                return;
            }

            const location = {
                latitude: 19.4326,
                longitude: -99.1332,
                radius: 5
            };

            log(`ğŸ” Buscando vendedores cercanos en ${location.latitude}, ${location.longitude} (radio: ${location.radius}km)`, 'info');
            socket.emit('get_nearby_vendors', location);
        }

        function testNewOrder() {
            if (!socket || !socket.connected) {
                log('âŒ Socket no conectado', 'error');
                return;
            }

            const orderData = {
                id: Date.now().toString(),
                vendorId: 'test-vendor-completo',
                clientName: 'Cliente Test Completo',
                items: [
                    {
                        producto: { id: '1', nombre: 'Taco Test', precio: 25 },
                        cantidad: 2
                    },
                    {
                        producto: { id: '2', nombre: 'Quesadilla Test', precio: 30 },
                        cantidad: 1
                    }
                ],
                total: 80,
                timestamp: new Date().toISOString()
            };

            log(`ğŸ›’ Enviando pedido: ${JSON.stringify(orderData)}`, 'info');
            socket.emit('new_order', orderData);
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                log('ğŸ”Œ Desconectando WebSocket...', 'info');
            }
        }

        function clearLogs() {
            logsEl.innerHTML = '';
            log('ğŸ§¹ Logs limpiados', 'info');
        }

        // Auto-test al cargar
        window.onload = () => {
            log('ğŸš€ PÃ¡gina cargada, listo para probar WebSocket completo', 'info');
            log('ğŸ’¡ 1. Haz clic en "Test Health Check"', 'info');
            log('ğŸ’¡ 2. Haz clic en "Conectar WebSocket"', 'info');
            log('ğŸ’¡ 3. Prueba las funcionalidades especÃ­ficas', 'info');
        };
    </script>
</body>
</html>
