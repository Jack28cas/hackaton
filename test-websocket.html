<!DOCTYPE html>
<html>
<head>
    <title>Test WebSocket VendedoresApp</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .error { background: #fff3cd; color: #856404; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        .logs { background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .log-item { margin: 5px 0; padding: 5px; border-left: 3px solid #007bff; }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .info { border-left-color: #17a2b8; }
    </style>
</head>
<body>
    <h1>🧪 Test WebSocket VendedoresApp</h1>
    
    <div id="status" class="status disconnected">Estado: Desconectado</div>
    
    <div>
        <h3>🔌 Conexión</h3>
        <button onclick="testConnection('CLIENTE')">Conectar como Cliente</button>
        <button onclick="testConnection('VENDEDOR')">Conectar como Vendedor</button>
        <button onclick="disconnect()">Desconectar</button>
    </div>

    <div>
        <h3>📡 Eventos de Vendedor</h3>
        <button onclick="testVendorConnect()">Conectar Vendedor</button>
        <button onclick="testVendorDisconnect()">Desconectar Vendedor</button>
        <button onclick="testUpdateLocation()">Actualizar Ubicación</button>
    </div>

    <div>
        <h3>🛒 Eventos de Cliente</h3>
        <button onclick="testNewOrder()">Enviar Pedido</button>
        <button onclick="testGetNearbyVendors()">Buscar Vendedores Cercanos</button>
    </div>

    <div>
        <h3>📊 Logs</h3>
        <button onclick="clearLogs()">Limpiar Logs</button>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        let socket;
        let currentUserType = 'CLIENTE';
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-item ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logsEl.appendChild(div);
            logsEl.scrollTop = logsEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(text, type) {
            statusEl.textContent = `Estado: ${text}`;
            statusEl.className = `status ${type}`;
        }

        function testConnection(userType) {
            if (socket) {
                socket.disconnect();
            }

            currentUserType = userType;
            log(`Intentando conectar como ${userType}...`, 'info');

            socket = io('http://localhost:3001', {
                auth: {
                    userType: userType,
                    userId: userType === 'VENDEDOR' ? 'vendor-demo-1' : 'client-demo-1'
                }
            });

            socket.on('connect', () => {
                updateStatus(`Conectado como ${userType} ✅`, 'connected');
                log(`Socket conectado exitosamente como ${userType}`, 'success');
            });

            socket.on('disconnect', (reason) => {
                updateStatus('Desconectado ❌', 'disconnected');
                log(`Socket desconectado: ${reason}`, 'error');
            });

            socket.on('connect_error', (err) => {
                updateStatus(`Error de conexión ❌`, 'error');
                log(`Error de conexión: ${err.message}`, 'error');
            });

            // Eventos de vendedor
            socket.on('order_received', (data) => {
                log(`📥 Pedido recibido: ${JSON.stringify(data)}`, 'success');
            });

            // Eventos de cliente
            socket.on('nearby_vendors', (vendors) => {
                log(`📍 Vendedores cercanos encontrados: ${vendors.length}`, 'success');
                vendors.forEach(vendor => {
                    log(`  - ${vendor.name} (${vendor.distance}km)`, 'info');
                });
            });

            socket.on('order_accepted', (data) => {
                log(`✅ Pedido aceptado: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('order_rejected', (data) => {
                log(`❌ Pedido rechazado: ${JSON.stringify(data)}`, 'error');
            });

            // Eventos generales
            socket.on('vendor_connected', (data) => {
                log(`🟢 Vendedor conectado: ${data.name}`, 'success');
            });

            socket.on('vendor_disconnected', (data) => {
                log(`🔴 Vendedor desconectado: ${data.vendorId}`, 'error');
            });

            socket.on('error', (data) => {
                log(`❌ Error del servidor: ${data.message}`, 'error');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                log('Desconectando socket...', 'info');
            }
        }

        function testVendorConnect() {
            if (!socket || !socket.connected) {
                log('❌ Socket no conectado', 'error');
                return;
            }

            const location = {
                latitude: 19.4326 + (Math.random() - 0.5) * 0.01,
                longitude: -99.1332 + (Math.random() - 0.5) * 0.01
            };

            log(`📍 Conectando vendedor en ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`, 'info');
            socket.emit('vendor_connect', location);
        }

        function testVendorDisconnect() {
            if (!socket || !socket.connected) {
                log('❌ Socket no conectado', 'error');
                return;
            }

            log('🔌 Desconectando vendedor...', 'info');
            socket.emit('vendor_disconnect');
        }

        function testUpdateLocation() {
            if (!socket || !socket.connected) {
                log('❌ Socket no conectado', 'error');
                return;
            }

            const location = {
                latitude: 19.4326 + (Math.random() - 0.5) * 0.01,
                longitude: -99.1332 + (Math.random() - 0.5) * 0.01
            };

            log(`📍 Actualizando ubicación a ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`, 'info');
            socket.emit('update_location', location);
        }

        function testNewOrder() {
            if (!socket || !socket.connected) {
                log('❌ Socket no conectado', 'error');
                return;
            }

            const orderData = {
                id: Date.now().toString(),
                vendorId: 'vendor-demo-1',
                clientName: 'Cliente Test',
                items: [
                    {
                        producto: { id: '1', nombre: 'Taco Test', precio: 25 },
                        cantidad: 2
                    },
                    {
                        producto: { id: '2', nombre: 'Quesadilla Test', precio: 30 },
                        cantidad: 1
                    }
                ],
                total: 80,
                timestamp: new Date().toISOString()
            };

            log(`🛒 Enviando pedido: ${JSON.stringify(orderData)}`, 'info');
            socket.emit('new_order', orderData);
        }

        function testGetNearbyVendors() {
            if (!socket || !socket.connected) {
                log('❌ Socket no conectado', 'error');
                return;
            }

            const location = {
                latitude: 19.4326,
                longitude: -99.1332,
                radius: 5
            };

            log(`🔍 Buscando vendedores cercanos en ${location.latitude}, ${location.longitude} (radio: ${location.radius}km)`, 'info');
            socket.emit('get_nearby_vendors', location);
        }

        function clearLogs() {
            logsEl.innerHTML = '';
            log('Logs limpiados', 'info');
        }

        // Auto-conectar al cargar
        window.onload = () => {
            log('Página cargada, listo para probar WebSocket', 'info');
        };
    </script>
</body>
</html>
